# Глобальный анализ всех сценариев бота и выявление проблем

## Обзор
Этот документ содержит полный анализ всех возможных сценариев использования бота, выявленные проблемы и рекомендации по их исправлению.

## Краткое резюме

### Статус сценариев:
- **✅ Работают корректно**: 16 сценариев
- **⚠️ Требуют проверки**: 2 сценария

### Критические проблемы:
1. **Сохранение photo_file_id при загрузке документов** - при загрузке документа через кнопку "Прикрепить" или drag-drop, `photo_file_id` может не сохраняться в `user_data` при сохранении лида (в процессе диагностики)
2. **Активация ConversationHandler при установке ADD_REVIEW** - частично исправлено через entry points, но требует проверки во всех случаях

### Недавно исправленные проблемы:
1. **✅ Поиск по fullname не находил лиды по другим полям** - исправлено: теперь `check_by_fullname` ищет по всем полям одновременно (fullname, telegram_user, telegram_id, facebook_link)

### Приоритет исправлений:
1. **Приоритет 1 (Критический)**: Исправление проблемы с сохранением photo_file_id для документов
2. **Приоритет 2 (Важный)**: Проверка активации ConversationHandler во всех edge cases
3. **Приоритет 3 (Желательный)**: Улучшение логирования для диагностики

---

## 1. СЦЕНАРИИ ПРОВЕРКИ (CHECK FLOW)

### 1.1. Базовый сценарий проверки
**Сценарий**: Пользователь нажимает "Проверить" → вводит данные → получает результат

**Цепочка функций**:
- `check_menu_callback` (строка 1977) → устанавливает `SMART_CHECK_INPUT`
- `smart_check_input` (строка 3390) → определяет тип данных и вызывает соответствующий поиск
- `check_by_field` / `check_by_fullname` / `check_by_multiple_fields` → выполняет поиск

**Статус**: ✅ Работает корректно
- `smart_check_input` проверяет, не находится ли пользователь в ADD flow (строка 3396-3403)
- Состояние очищается после завершения проверки
- **Улучшение**: `check_by_fullname` теперь ищет по всем полям одновременно (fullname, telegram_user, telegram_id, facebook_link), что позволяет находить лиды даже если они были добавлены с другими данными

**Потенциальные проблемы**: Нет

---

### 1.2. Пересылка сообщения → Проверить
**Сценарий**: Пользователь пересылает сообщение → выбирает "Проверить" → получает результат

**Цепочка функций**:
- `handle_forwarded_message` (строка 1138) → извлекает данные, показывает кнопки
- `forwarded_check_callback` (строка 4318) → вызывает `check_by_extracted_fields`
- `check_by_extracted_fields` (строка 4356) → выполняет поиск

**Статус**: ✅ Исправлено
- Состояние очищается после проверки (строка 4631-4634)
- Кнопка "Проверить" работает после проверки

**Потенциальные проблемы**: Нет

---

### 1.3. Пересылка во время check flow
**Сценарий**: Пользователь в check flow → пересылает сообщение → автоматическая проверка

**Цепочка функций**:
- `handle_forwarded_message` (строка 1249-1299) → определяет, что пользователь в `SMART_CHECK_INPUT`
- `check_by_extracted_fields` → выполняет поиск
- Возвращает `ConversationHandler.END`

**Статус**: ✅ Исправлено
- Состояние очищается после проверки (строка 4631-4634)

**Потенциальные проблемы**: Нет

---

## 2. СЦЕНАРИИ ДОБАВЛЕНИЯ (ADD FLOW)

### 2.1. Базовый сценарий добавления
**Сценарий**: Пользователь нажимает "Добавить" → последовательно заполняет поля → сохраняет

**Цепочка функций**:
- `add_new_callback` (строка 2511) → инициализирует ADD flow, устанавливает `ADD_FULLNAME`
- `add_field_input` (строка 3618) → обрабатывает ввод каждого поля
- `show_add_review` (строка 4198) → показывает Review
- `add_save_callback` (строка 5064) → сохраняет лид

**Статус**: ✅ Работает корректно
- Все поля обрабатываются последовательно
- Навигация (Назад, Пропустить, Отменить) работает

**Потенциальные проблемы**: Нет

---

### 2.2. Пересылка сообщения → Добавить
**Сценарий**: Пользователь пересылает сообщение → выбирает "Добавить" → Review → Сохранить

**Цепочка функций**:
- `handle_forwarded_message` (строка 1147) → извлекает данные, показывает кнопки
- `forwarded_add_callback` (строка 4443) → устанавливает `ADD_REVIEW`, вызывает `show_add_review`
- `check_add_state_entry_callback` (строка 1012) → обрабатывает callbacks для активации ConversationHandler
- `add_save_callback` (строка 5257) → сохраняет лид

**Статус**: ✅ Работает корректно
- `check_add_state_entry_callback` обрабатывает все callbacks в состоянии ADD_REVIEW (строки 1048-1071)
- `unknown_callback_handler` также обрабатывает callbacks в состоянии ADD_REVIEW (строки 2208-2220)
- Состояние полностью очищается после сохранения (строка 5586)

**Потенциальные проблемы**: Нет

---

### 2.3. Пересылка во время add flow
**Сценарий**: Пользователь в add flow → пересылает сообщение → автоматический переход к Review

**Цепочка функций**:
- `handle_forwarded_message` (строки 1219-1257) → определяет, что пользователь в add flow
- Извлекает данные, устанавливает `ADD_REVIEW`, вызывает `show_add_review`
- `check_add_state_entry_callback` (строка 1012) → обрабатывает callbacks для активации ConversationHandler
- Возвращает `ADD_REVIEW`

**Статус**: ✅ Работает корректно
- `check_add_state_entry_callback` обрабатывает все callbacks в состоянии ADD_REVIEW (строки 1048-1071)
- `unknown_callback_handler` также обрабатывает callbacks в состоянии ADD_REVIEW (строки 2208-2220)
- Состояние полностью очищается после сохранения (строка 5586)

**Потенциальные проблемы**: Нет

---

### 2.4. Отправка фото → Добавление
**Сценарий**: Пользователь отправляет фото → начинается add flow → заполняет поля → сохраняет

**Цепочка функций**:
- `handle_photo_message` (строка 1422) → извлекает фото, устанавливает состояние
- `add_field_input` → обрабатывает ввод полей
- `show_add_review` → показывает Review
- `add_save_callback` → сохраняет лид с фото

**Статус**: ✅ Работает корректно
- Фото сохраняется в `user_data_store` (строка 1477)
- Текст во время add flow не обрабатывается как проверка (исправлено в `smart_check_input`)

**Потенциальные проблемы**: Нет

---

### 2.5. Отправка фото во время add flow
**Сценарий**: Пользователь в add flow → отправляет фото → фото сохраняется → продолжает заполнение

**Цепочка функций**:
- `handle_photo_during_add` (строка 4275) → сохраняет фото в `user_data_store`
- Возвращает текущее состояние для продолжения flow

**Статус**: ✅ Работает корректно
- Фото сохраняется в `user_data_store` (строка 4295)
- Flow продолжается после сохранения фото (строка 4307)

**Потенциальные проблемы**: Нет

---

### 2.6. Пересылка сообщения с фото во время add flow
**Сценарий**: Пользователь в add flow → пересылает сообщение с фото → данные извлекаются → переход к Review

**Цепочка функций**:
- `handle_forwarded_message` (строки 1219-1257) → извлекает данные включая фото
- `extract_data_from_forwarded_message` (строка 1079) → извлекает фото
- `show_add_review` (строка 4266) → показывает Review
- `check_add_state_entry_callback` (строка 1012) → обрабатывает callbacks для активации ConversationHandler

**Статус**: ✅ Работает корректно
- Фото правильно извлекается и сохраняется в `user_data_store`
- `check_add_state_entry_callback` обрабатывает все callbacks в состоянии ADD_REVIEW
- Состояние полностью очищается после сохранения

**Потенциальные проблемы**: Нет

---

### 2.7. Отправка документа во время add flow
**Сценарий**: Пользователь в add flow → отправляет документ (изображение) через кнопку "Прикрепить" или drag-drop → документ сохраняется → продолжает заполнение

**Цепочка функций**:
- `handle_document_during_add` (строка 4384) → проверяет, что документ является изображением, сохраняет `file_id` в `user_data_store`
- Возвращает текущее состояние для продолжения flow
- `add_save_callback` (строка 5257) → должен загрузить фото из `user_data`

**Статус**: ⚠️ Требует проверки

**Выявленные проблемы**:
1. **ПРОБЛЕМА**: При загрузке документа через кнопку "Прикрепить" или drag-drop, `photo_file_id` сохраняется в `user_data_store`, но может не передаваться в `user_data` при сохранении лида
   - **Причина**: `add_save_callback` получает `user_data` из `user_data_store.get(user_id, {})`, но между сохранением документа и сохранением лида данные могут теряться
   - **Статус**: В процессе диагностики (добавлено логирование в строках 4419-4430 и 5424-5426)
   - **Рекомендация**: Проверить логи для выявления места потери данных

**Потенциальные проблемы**:
- `photo_file_id` может не сохраняться при сохранении лида, если данные теряются между сохранением документа и сохранением лида

---

## 3. СЦЕНАРИИ РЕДАКТИРОВАНИЯ (EDIT FLOW)

### 3.1. Базовый сценарий редактирования
**Сценарий**: Пользователь нажимает "Редактировать" на лиде → вводит PIN → выбирает поле → редактирует → сохраняет

**Цепочка функций**:
- `edit_lead_callback` (строка 5409) → устанавливает `EDIT_PIN`
- `edit_pin_input` → проверяет PIN, переходит к `EDIT_MENU`
- `edit_field_*_callback` → устанавливает состояние редактирования поля
- `edit_field_input` → обрабатывает ввод
- `edit_save_callback` (строка 5812) → сохраняет изменения

**Статус**: ✅ Работает корректно
- Все этапы обрабатываются через ConversationHandler
- Навигация работает

**Потенциальные проблемы**: Нет

---

### 3.2. Пересылка во время edit flow
**Сценарий**: Пользователь в edit flow → пересылает сообщение → должно быть отклонено

**Цепочка функций**:
- `handle_forwarded_message` (строка 1190-1198) → проверяет, что пользователь в edit flow
- Отклоняет пересылку с сообщением

**Статус**: ✅ Работает корректно
- Пересылка правильно отклоняется

**Потенциальные проблемы**: Нет

---

## 4. СЦЕНАРИИ ТЕГОВ (TAG FLOW)

### 4.1. Базовый сценарий изменения тега
**Сценарий**: Пользователь вводит `/tag` → вводит PIN → выбирает менеджера → вводит новый тег → подтверждает

**Цепочка функций**:
- `tag_command` (строка 1573) → устанавливает `TAG_PIN`
- `tag_pin_input` → проверяет PIN, переходит к `TAG_SELECT_MANAGER`
- `tag_manager_callback` (строка 1751) → выбирает менеджера, переходит к `TAG_ENTER_NEW`
- `tag_enter_new` (строка 3502) → вводит новый тег, показывает подтверждение
- `tag_confirm_callback` (строка 4980) → сохраняет изменения

**Статус**: ✅ Работает корректно
- Все этапы обрабатываются через ConversationHandler
- Навигация работает

**Потенциальные проблемы**: Нет

---

### 4.2. Пересылка во время tag flow
**Сценарий**: Пользователь в tag flow → пересылает сообщение → должно быть отклонено

**Цепочка функций**:
- `handle_forwarded_message` (строка 1200-1208) → проверяет, что пользователь в tag flow
- Отклоняет пересылку с сообщением

**Статус**: ✅ Работает корректно
- Пересылка правильно отклоняется

**Потенциальные проблемы**: Нет

---

## 5. СМЕШАННЫЕ И ГРАНИЧНЫЕ СЦЕНАРИИ

### 5.1. Прерывание flows командами
**Сценарий**: Пользователь в любом flow → вводит `/q` или `/start` → flow должен завершиться

**Цепочка функций**:
- `quit_command` (строка 1863) → очищает состояние, показывает главное меню
- `start_command` (строка 1539) → очищает состояние, показывает главное меню
- Оба в fallbacks всех ConversationHandlers

**Статус**: ✅ Работает корректно
- Все flows правильно завершаются
- Состояние очищается

**Потенциальные проблемы**: Нет

---

### 5.2. Неизвестные команды/callbacks
**Сценарий**: Пользователь отправляет неизвестную команду или нажимает неизвестную кнопку

**Цепочка функций**:
- `unknown_command_handler` (строка 2262) → обрабатывает неизвестные команды
- `unknown_callback_handler` (строка 2143) → обрабатывает неизвестные callbacks

**Статус**: ⚠️ Требует проверки

**Выявленные проблемы**:
1. **ПРОБЛЕМА**: `unknown_callback_handler` может конфликтовать с активными flows
   - **Текущее решение**: Проверяет, находится ли пользователь в ADD flow, и возвращает None для активации ConversationHandler (строка 2169-2189)
   - **Рекомендация**: Убедиться, что логика работает для всех случаев

**Потенциальные проблемы**:
- Может неправильно обрабатывать callbacks для активных flows
- Нужно проверить все edge cases

---

### 5.3. Одновременная работа нескольких пользователей
**Сценарий**: Несколько пользователей работают одновременно

**Механизм**:
- `user_data_store` изолирован по `user_id` (строка 709)
- Каждый пользователь имеет свой собственный словарь данных

**Статус**: ✅ Работает корректно
- Данные изолированы между пользователями
- Нет race conditions

**Потенциальные проблемы**: Нет

---

## 6. КРИТИЧЕСКИЕ ПРОБЛЕМЫ И РЕКОМЕНДАЦИИ

### Проблема 1: Поиск по fullname не находил лиды по другим полям
**Описание**: Когда пользователь вводил fullname (например, "Vikto") для проверки, бот искал только в поле `fullname`. Если лид был добавлен с fullname "Vikto" и Facebook ссылкой (без данных Telegram), поиск не находил его.

**Затронутые сценарии**:
- 1.1. Базовый сценарий проверки (когда пользователь вводит fullname)

**Текущее решение**: ✅ Исправлено
- `check_by_fullname` модифицирована для поиска по всем полям одновременно (строка 3178)
- Функция теперь ищет в: `fullname` (ILIKE - частичное совпадение), `telegram_user` (точное совпадение), `telegram_id` (точное совпадение), `facebook_link` (точное совпадение)
- Результаты из всех полей объединяются, дубликаты удаляются по ID
- Лимит результатов: 10 (сортировка по дате создания, новые сначала)

**Дата исправления**: 2026-01-26

---

### Проблема 2: Сохранение photo_file_id при загрузке документов
**Описание**: При загрузке документа через кнопку "Прикрепить" или drag-drop во время add flow, `photo_file_id` сохраняется в `user_data_store`, но может не передаваться в `user_data` при сохранении лида.

**Затронутые сценарии**:
- 2.7. Отправка документа во время add flow

**Текущее решение**: ⚠️ В процессе диагностики
- `handle_document_during_add` сохраняет `photo_file_id` в `user_data_store[user_id]['photo_file_id']` (строка 4426)
- Добавлено подробное логирование для диагностики (строки 4419-4430, 5424-5426)
- `add_save_callback` получает `user_data` из `user_data_store.get(user_id, {})` (строка 5262)

**Выявленные проблемы**:
1. **ПРОБЛЕМА**: `photo_file_id` может теряться между сохранением документа и сохранением лида
   - **Возможные причины**: 
     - `user_data_store[user_id]` может быть перезаписан или очищен между сохранением документа и сохранением лида
     - Данные могут не синхронизироваться между `user_data_store` и `user_data` в `add_save_callback`
   - **Статус**: В процессе диагностики - добавлено логирование для выявления места потери данных

**Рекомендации**:
1. **Проверить логи**: Использовать добавленное логирование для выявления места потери `photo_file_id`
2. **Проверить очистку user_data_store**: Убедиться, что `user_data_store[user_id]` не очищается между сохранением документа и сохранением лида
3. **Проверить синхронизацию данных**: Убедиться, что `user_data` в `add_save_callback` содержит все данные из `user_data_store[user_id]`

---

### Проблема 3: Активация ConversationHandler при установке ADD_REVIEW через глобальные обработчики
**Описание**: Когда `handle_forwarded_message` устанавливает состояние `ADD_REVIEW` напрямую, ConversationHandler может не активироваться автоматически.

**Затронутые сценарии**:
- 2.2. Пересылка сообщения → Добавить
- 2.3. Пересылка во время add flow
- 2.6. Пересылка сообщения с фото во время add flow

**Текущее решение**: ✅ Частично исправлено
- `check_add_state_entry_callback` обрабатывает все callbacks для состояния ADD_REVIEW (строки 1048-1071)
- `unknown_callback_handler` также обрабатывает callbacks в состоянии ADD_REVIEW (строки 2208-2220)
- Все callbacks (`add_save`, `add_back`, `add_cancel`, `edit_fullname_from_review`) обрабатываются корректно

**Рекомендации**:
1. **Проверить все edge cases**: Убедиться, что механизм активации ConversationHandler работает во всех возможных случаях
2. **Мониторинг**: Следить за логами для выявления случаев, когда ConversationHandler не активируется

---

## 7. РЕКОМЕНДАЦИИ ПО ИСПРАВЛЕНИЮ

### Приоритет 1 (Критический): Исправление проблемы с сохранением photo_file_id для документов
1. **Проверить логи**: Использовать добавленное логирование для выявления места потери `photo_file_id`
2. **Проверить очистку user_data_store**: Убедиться, что `user_data_store[user_id]` не очищается между сохранением документа и сохранением лида
3. **Проверить синхронизацию данных**: Убедиться, что `user_data` в `add_save_callback` содержит все данные из `user_data_store[user_id]`

### Приоритет 2 (Важный): Проверка активации ConversationHandler
1. Проверить все edge cases для активации ConversationHandler
2. Мониторить логи для выявления случаев, когда ConversationHandler не активируется

### Приоритет 3 (Желательный): Улучшение логирования
1. Добавить больше логирования для диагностики проблем с сохранением `photo_file_id`
2. Логировать все переходы состояний

---

## 8. ЗАКЛЮЧЕНИЕ

### Работающие сценарии (✅):
- Базовый сценарий проверки (улучшен: поиск по fullname теперь ищет по всем полям)
- Пересылка сообщения → Проверить
- Пересылка во время check flow
- Базовый сценарий добавления
- Пересылка сообщения → Добавить
- Пересылка во время add flow
- Отправка фото → Добавление
- Отправка фото во время add flow
- Пересылка сообщения с фото во время add flow
- Базовый сценарий редактирования
- Пересылка во время edit flow
- Базовый сценарий изменения тега
- Пересылка во время tag flow
- Прерывание flows командами
- Одновременная работа нескольких пользователей

### Сценарии, требующие проверки (⚠️):
- Отправка документа во время add flow (проблема с сохранением photo_file_id)
- Неизвестные команды/callbacks (требует проверки)

### Основные проблемы:

1. **Сохранение photo_file_id при загрузке документов** - при загрузке документа через кнопку "Прикрепить" или drag-drop, `photo_file_id` может не сохраняться в `user_data` при сохранении лида. Проблема в процессе диагностики с добавленным логированием.

2. **Активация ConversationHandler при установке ADD_REVIEW** - частично исправлено через entry points (`check_add_state_entry_callback` и `unknown_callback_handler`), но требует проверки во всех edge cases.

### Недавно исправленные проблемы:

1. **✅ Поиск по fullname не находил лиды по другим полям** - исправлено: `check_by_fullname` теперь ищет по всем полям одновременно (fullname, telegram_user, telegram_id, facebook_link), что позволяет находить лиды даже если они были добавлены с другими данными. Дата исправления: 2026-01-26.

### Рекомендуемые действия:
1. Исправить проблему с сохранением `photo_file_id` для документов (использовать логи для диагностики)
2. Проверить все edge cases для активации ConversationHandler
3. Улучшить логирование для диагностики проблем
4. Протестировать все сценарии, особенно сценарий 2.7 (отправка документа)

